C51 COMPILER V9.60.7.0   KEY_DRIVER                                                        01/17/2026 16:42:34 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE KEY_DRIVER
OBJECT MODULE PLACED IN .\Release\Objects\key_driver.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE ..\..\User\key_driver.c LARGE OPTIMIZE(9,SIZE) BROWSE INTVECTOR(0X000C) 
                    -INCDIR(..\..\Libraries\Include;..\..\User) INTERVAL(3) DEBUG OBJECTEXTEND PRINT(.\Release\Listings\key_driver.lst) OBJEC
                    -T(.\Release\Objects\key_driver.obj)

line level    source

   1          #include "key_driver.h"
   2          
   3          enum
   4          {
   5              KEY_SCAN_STATUS_NONE = 0,       // æ— ç‰¹æ®ŠçŠ¶æ€
   6              KEY_SCAN_STATUS_TO_NOTIFY,      // å‘é€æŒ‰é”®æ¶ˆæ¯
   7              KEY_SCAN_STATUS_TO_END_OF_SCAN, // æŒ‰é”®æ‰«æç»“æŸï¼Œè¿›è¡Œæ”¶å°¾å¤„ç†
   8          };
   9          
  10          static volatile u8 is_key_active = 0; // æŒ‰é”®æ˜¯å¦æœ‰æ•ˆçš„è®¡æ•°å€¼
  11          
  12          //=======================================================//
  13          // æŒ‰é”®æ‰«æå‡½æ•°: æ‰«ææ‰€æœ‰æ³¨å†Œçš„æŒ‰é”®é©±åŠ¨
  14          //=======================================================//
  15          xdata volatile struct key_driver_para *scan_para; // è¦è®©æŒ‡é’ˆæŒ‡å‘xdataåŒºåŸŸçš„å…¨å±€å˜é‡ï¼Œéœ€è¦
             -åŒæ ·å°†æŒ‡é’ˆå˜ä¸ºå…¨å±€å˜é‡
  16          void key_driver_scan(void *_scan_para)
  17          // struct key_driver_para key_driver_scan(struct key_driver_para scan_para)
  18          {
  19   1          // volatile struct key_driver_para xdata *scan_para = (struct key_driver_para xdata *)_scan_para; // å
             -‡½æ•°å†…éƒ¨çš„æŒ‡é’ˆåªèƒ½æŒ‡å‘idataç©ºé—´ï¼Œä¸èƒ½æŒ‡å‘å…¨å±€å˜é‡çš„xdataç©ºé—´
  20   1          // volatile struct key_driver_para xdata *scan_para = (struct key_driver_para xdata *)0x642D; // ç³»ç»
             -Ÿä¼šä¸€ç›´å¤ä½
  21   1      
  22   1      #if 1
  23   1          u8 key_event = KEY_EVENT_NONE; // å­˜æ”¾å¾…å‘é€çš„æŒ‰é”®äº‹ä»¶
  24   1          u8 cur_key_value = NO_KEY;     // å­˜æ”¾å¾…å‘é€çš„æŒ‰é”®é”®å€¼
  25   1          u8 key_value = NO_KEY;
  26   1      
  27   1          // u8 key_scan_status = KEY_SCAN_STATUS_NONE; // çŠ¶æ€æœºï¼Œè´Ÿè´£æŽ§åˆ¶è¯¥å‡½æ•°å†…çš„è·³è½¬æ“ä½œ /
             -* æŽ§åˆ¶è·³è½¬è¿˜æœ‰é—®é¢˜ï¼Œè¿˜ä¸èƒ½ä½¿ç”¨ */
  28   1      
  29   1          scan_para = (struct key_driver_para *)_scan_para;
  30   1      
  31   1          // å¦‚æžœæ‰«ææ—¶é—´æœªåˆ°æ¥ï¼Œä¸æ‰§è¡ŒæŒ‰é”®æ‰«æ
  32   1          if (scan_para->cur_scan_times < scan_para->scan_times)
  33   1          {
  34   2              return;
  35   2          }
  36   1      
  37   1          scan_para->cur_scan_times = 0; // æ¸…ç©ºæ‰«ææ—¶é—´
  38   1      
  39   1          cur_key_value = scan_para->get_value(); // è°ƒç”¨ç”¨æˆ·è‡ªå®šä¹‰çš„èŽ·å–é”®å€¼å‡½æ•°
  40   1      
  41   1          // if (cur_key_value != NO_KEY)
  42   1          //     printf("key id %bu\n", cur_key_value); // æ‰“å°èŽ·å–åˆ°çš„é”®å€¼
  43   1      
  44   1          // åˆ¤æ–­æŒ‰é”®æ˜¯å¦æœ‰æ•ˆ
  45   1          if (cur_key_value != NO_KEY)
  46   1          {
  47   2              is_key_active = 35; // 35*10Ms
  48   2          }
  49   1          else if (is_key_active)
C51 COMPILER V9.60.7.0   KEY_DRIVER                                                        01/17/2026 16:42:34 PAGE 2   

  50   1          {
  51   2              is_key_active--;
  52   2          }
  53   1      
  54   1          // if (cur_key_value != NO_KEY)
  55   1          // {
  56   1          //     //     printf("scan_times %bu\n", scan_para->scan_times);
  57   1          //     //     printf("cur_scan_times %bu\n", scan_para->cur_scan_times);
  58   1          //     //     printf("last_key %bu\n", scan_para->last_key);
  59   1          //     //     printf("filter_value %bu\n", scan_para->filter_value);
  60   1          //     //     printf("filter_cnt %bu\n", scan_para->filter_cnt);
  61   1          //     //     printf("filter_time %bu\n", scan_para->filter_time);
  62   1          //     printf("long_time %bu\n", ad_key_para.long_time);
  63   1          //     printf("long_time %bu\n", (*scan_para).long_time);
  64   1          //     //     printf("hold_time %bu\n", scan_para->hold_time);
  65   1          //     //     printf("press_cnt %bu\n", scan_para->press_cnt);
  66   1      
  67   1          //     //     printf("click_cnt %bu\n", scan_para->click_cnt);
  68   1          //     //     printf("click_delay_cnt %bu\n", scan_para->click_delay_cnt);
  69   1          //     //     printf("click_delay_time %bu\n", scan_para->click_delay_time);
  70   1          //     //     printf("notify_value %bu\n", scan_para->notify_value);
  71   1          //     //     printf("key_type %bu\n", scan_para->key_type);
  72   1      
  73   1          //     //     printf("latest_key_val %bu\n", scan_para->latest_key_val);
  74   1          //     //     printf("latest_key_event %bu\n", scan_para->latest_key_event);
  75   1      
  76   1          //     printf("ad key long time addr %p\n", &ad_key_para.long_time);
  77   1          //     // printf("scan para long time addr %p\n", &(scan_para->long_time));
  78   1          //     printf("scan para long time addr %p\n", (*scan_para).long_time);
  79   1          // }
  80   1      
  81   1          //===== æŒ‰é”®æ¶ˆæŠ–å¤„ç†
  82   1          if (cur_key_value != scan_para->filter_value && scan_para->filter_time)
  83   1          {
  84   2              // å½“å‰æŒ‰é”®å€¼ä¸Žä¸Šä¸€æ¬¡æŒ‰é”®å€¼å¦‚æžœä¸ç›¸ç­‰, é‡æ–°æ¶ˆæŠ–å¤„ç†, æ³¨æ„filter_time != 0
             -;
  85   2              scan_para->filter_cnt = 0;               // æ¶ˆæŠ–æ¬¡æ•°æ¸…0, é‡æ–°å¼€å§‹æ¶ˆæŠ–
  86   2              scan_para->filter_value = cur_key_value; // è®°å½•ä¸Šä¸€æ¬¡çš„æŒ‰é”®å€¼
  87   2              return;                                  // ç¬¬ä¸€æ¬¡æ£€æµ‹, è¿”å›žä¸åšå¤„ç†
  88   2          }
  89   1      
  90   1          // å½“å‰æŒ‰é”®å€¼ä¸Žä¸Šä¸€æ¬¡æŒ‰é”®å€¼ç›¸ç­‰, filter_cntå¼€å§‹ç´¯åŠ ;
  91   1          if (scan_para->filter_cnt < scan_para->filter_time)
  92   1          {
  93   2              scan_para->filter_cnt++;
  94   2              return;
  95   2          }
  96   1      
  97   1          //===== æŒ‰é”®æ¶ˆæŠ–ç»“æŸ, å¼€å§‹åˆ¤æ–­æŒ‰é”®ç±»åž‹(å•å‡», åŒå‡», é•¿æŒ‰, å¤šå‡», HOLD, (é•¿æŒ‰/HOL
             -D)æŠ¬èµ·)
  98   1          if (cur_key_value != scan_para->last_key)
  99   1          {
 100   2              /*
 101   2                  å¦‚æžœå½“å‰çš„é”®å€¼ä¸ºç©ºï¼Œä¸Šä¸€æ¬¡çš„é”®å€¼åˆä¸Žå½“å‰çš„é”®å€¼ä¸ä¸€æ ·ï¼Œè¯´æ˜ŽæŒ‰é”®æ
             -¾å¼€
 102   2                  cur_key = NO_KEY; last_key = valid_key -> æŒ‰é”®è¢«æŠ¬èµ·
 103   2              */
 104   2              // printf("key event up\n");
 105   2      
 106   2              if (cur_key_value == NO_KEY)
 107   2              {
 108   3                  if (scan_para->press_cnt >= scan_para->long_time)
C51 COMPILER V9.60.7.0   KEY_DRIVER                                                        01/17/2026 16:42:34 PAGE 3   

 109   3                  { // é•¿æŒ‰/HOLDçŠ¶æ€ä¹‹åŽè¢«æŒ‰é”®æŠ¬èµ·;
 110   4                      key_event = KEY_EVENT_UP;
 111   4                      key_value = scan_para->last_key;
 112   4                      goto _notify; // å‘é€æŠ¬èµ·æ¶ˆæ¯
 113   4                      // key_scan_status = KEY_SCAN_STATUS_TO_NOTIFY; // è·³è½¬åˆ°å‘é€æŒ‰é”®äº‹ä»¶çš„æ“ä½œ
 114   4                  }
 115   3      
 116   3                  // if (KEY_SCAN_STATUS_NONE == key_scan_status) // å¦‚æžœæ²¡æœ‰ç‰¹æ®Šæ“ä½œ
 117   3                  {
 118   4                      scan_para->click_delay_cnt = 1; // æŒ‰é”®ç­‰å¾…ä¸‹æ¬¡è¿žå‡»å»¶æ—¶å¼€å§‹
 119   4                  }
 120   3              }
 121   2              else
 122   2              {
 123   3                  /*
 124   3                      å¦‚æžœå½“å‰çš„é”®å€¼ä¸ä¸ºç©ºï¼Œä¸Šä¸€æ¬¡çš„é”®å€¼åˆä¸Žå½“å‰çš„é”®å€¼ä¸ä¸€æ ·ï¼Œè¯´æ˜Ž
             -æŒ‰é”®æŒ‰ä¸‹
 125   3                      cur_key = valid_key, last_key = NO_KEY -> æŒ‰é”®è¢«æŒ‰ä¸‹
 126   3                  */
 127   3                  scan_para->press_cnt = 1; // ç”¨äºŽåˆ¤æ–­longå’Œholdäº‹ä»¶çš„è®¡æ•°å™¨é‡æ–°å¼€å§‹è®¡æ—¶;
 128   3                  if (cur_key_value != scan_para->notify_value)
 129   3                  { // ç¬¬ä¸€æ¬¡å•å‡»/è¿žå‡»æ—¶æŒ‰ä¸‹çš„æ˜¯ä¸åŒæŒ‰é”®, å•å‡»æ¬¡æ•°é‡æ–°å¼€å§‹è®¡æ•°
 130   4                      scan_para->click_cnt = 1;
 131   4                      scan_para->notify_value = cur_key_value;
 132   4                  }
 133   3                  else
 134   3                  {
 135   4                      scan_para->click_cnt++; // å•å‡»æ¬¡æ•°ç´¯åŠ 
 136   4                  }
 137   3              }
 138   2      
 139   2              goto _scan_end; // è¿”å›ž, ç­‰å¾…å»¶æ—¶æ—¶é—´åˆ°
 140   2              // if (KEY_SCAN_STATUS_NONE == key_scan_status)
 141   2              // {
 142   2              //     key_scan_status = KEY_SCAN_STATUS_TO_END_OF_SCAN; // è¿”å›ž, ç­‰å¾…å»¶æ—¶æ—¶é—´åˆ°
 143   2              // }
 144   2          }
 145   1          else
 146   1          {
 147   2              /*
 148   2                  å¦‚æžœå½“å‰èŽ·å–çš„é”®å€¼ä¸Žä¸Šæ¬¡èŽ·å–çš„é”®å€¼ä¸€æ ·ï¼Œè¯´æ˜ŽæŒ‰é”®åœ¨é•¿æŒ‰æˆ–æ˜¯æŒ‰é”®æ
             -œªæŒ‰ä¸‹
 149   2                  cur_key = last_key -> æ²¡æœ‰æŒ‰é”®æŒ‰ä¸‹/æŒ‰é”®é•¿æŒ‰(HOLD)
 150   2              */
 151   2              if (cur_key_value == NO_KEY)
 152   2              {
 153   3                  // last_key = NO_KEY; cur_key = NO_KEY -> æ²¡æœ‰æŒ‰é”®æŒ‰ä¸‹
 154   3                  if (scan_para->click_cnt > 0)
 155   3                  { // æœ‰æŒ‰é”®éœ€è¦æ¶ˆæ¯éœ€è¦å¤„ç†
 156   4      
 157   4                      // å¦‚æžœåªå“åº”å•å‡»äº‹ä»¶ï¼Œå¯ä»¥åœ¨è¿™é‡Œæ·»åŠ /ä¿®æ”¹åŠŸèƒ½
 158   4      
 159   4                      if (scan_para->click_delay_cnt > scan_para->click_delay_time)
 160   4                      { // æŒ‰é”®è¢«æŠ¬èµ·åŽå»¶æ—¶åˆ°
 161   5                          // TODO: åœ¨æ­¤å¯ä»¥æ·»åŠ ä»»æ„å¤šå‡»äº‹ä»¶
 162   5                          // if (scan_para->click_cnt >= 5)
 163   5                          // {
 164   5                          //     key_event = KEY_EVENT_FIRTH_CLICK; // äº”å‡»
 165   5                          // }
 166   5                          // else if (scan_para->click_cnt >= 4)
 167   5                          // {
 168   5                          //     key_event = KEY_EVENT_FOURTH_CLICK; // 4å‡»
C51 COMPILER V9.60.7.0   KEY_DRIVER                                                        01/17/2026 16:42:34 PAGE 4   

 169   5                          // }
 170   5                          // else if (scan_para->click_cnt >= 3)
 171   5                          // {
 172   5                          //     key_event = KEY_EVENT_TRIPLE_CLICK; // ä¸‰å‡»
 173   5                          // }
 174   5                          // else if (scan_para->click_cnt >= 2)
 175   5                          // if (scan_para->click_cnt >= 2)
 176   5                          // {
 177   5                          //     key_event = KEY_EVENT_DOUBLE_CLICK; // åŒå‡»
 178   5                          // }
 179   5                          // else
 180   5                          {
 181   6                              key_event = KEY_EVENT_CLICK; // å•å‡»
 182   6                              // printf("click \n");
 183   6                          }
 184   5                          key_value = scan_para->notify_value;
 185   5      
 186   5                          goto _notify;
 187   5                          // key_scan_status = KEY_SCAN_STATUS_TO_NOTIFY;
 188   5                      }
 189   4                      else
 190   4                      { // æŒ‰é”®æŠ¬èµ·åŽç­‰å¾…ä¸‹æ¬¡å»¶æ—¶æ—¶é—´æœªåˆ°
 191   5                          scan_para->click_delay_cnt++;
 192   5                          goto _scan_end; // æŒ‰é”®æŠ¬èµ·åŽå»¶æ—¶æ—¶é—´æœªåˆ°, è¿”å›ž
 193   5                          // key_scan_status = KEY_SCAN_STATUS_TO_END_OF_SCAN;
 194   5                      }
 195   4                  }
 196   3                  else
 197   3                  {
 198   4                      goto _scan_end; // æ²¡æœ‰æŒ‰é”®éœ€è¦å¤„ç†
 199   4                      // key_scan_status = KEY_SCAN_STATUS_TO_END_OF_SCAN;
 200   4                  }
 201   3              }
 202   2              else
 203   2              {
 204   3                  // last_key = valid_key; cur_key = valid_key, press_cntç´¯åŠ ç”¨äºŽåˆ¤æ–­longå’Œhold
 205   3                  if (scan_para->press_cnt < 255)
 206   3                  {
 207   4                      scan_para->press_cnt++;
 208   4                  }
 209   3      
 210   3                  // printf("long time %bu\n", scan_para->long_time);
 211   3                  // printf("press cnt %bu\n", scan_para->press_cnt);
 212   3                  if (scan_para->press_cnt == scan_para->long_time)
 213   3                  {
 214   4                      key_event = KEY_EVENT_LONG;
 215   4      
 216   4                      // printf("long time %bu\n", scan_para->long_time);
 217   4      
 218   4                      // printf("key event long\n");
 219   4                  }
 220   3                  else if (scan_para->press_cnt == scan_para->hold_time)
 221   3                  {
 222   4                      key_event = KEY_EVENT_HOLD;
 223   4                      scan_para->press_cnt = scan_para->long_time; // ä¸‹ä¸€æ¬¡scan_para->press_cnt++,è¿˜æ˜¯ä¼šè
             -¿›å…¥åˆ°è¿™é‡Œ
 224   4                      // printf("key event hold\n");
 225   4                  }
 226   3                  else
 227   3                  {
 228   4                      goto _scan_end; // press_cntæ²¡åˆ°é•¿æŒ‰å’ŒHOLDæ¬¡æ•°, è¿”å›ž
 229   4                      // key_scan_status = KEY_SCAN_STATUS_TO_END_OF_SCAN;
C51 COMPILER V9.60.7.0   KEY_DRIVER                                                        01/17/2026 16:42:34 PAGE 5   

 230   4                  }
 231   3      
 232   3                  // press_cntæ²¡åˆ°é•¿æŒ‰å’ŒHOLDæ¬¡æ•°, å‘æ¶ˆæ¯
 233   3                  key_value = cur_key_value;
 234   3                  goto _notify;
 235   3                  // key_scan_status = KEY_SCAN_STATUS_TO_NOTIFY;
 236   3              }
 237   2          }
 238   1      
 239   1      _notify:
 240   1      
 241   1          // if (KEY_SCAN_STATUS_TO_END_OF_SCAN != key_scan_status)
 242   1          {
 243   2              // if (KEY_TYPE_AD == scan_para->key_type) // å¦‚æžœæ˜¯adæŒ‰é”®
 244   2              {
 245   3                  scan_para->click_cnt = 0;         // æŒ‰ä¸‹æ¬¡æ•°æ¸…0
 246   3                  scan_para->notify_value = NO_KEY; // åœ¨å»¶æ—¶çš„å¾…å‘é€æŒ‰é”®å€¼æ¸…é›¶
 247   3      
 248   3                  scan_para->latest_key_val = key_value;   // å­˜æ”¾å¾—åˆ°çš„æŒ‰é”®é”®å€¼
 249   3                  scan_para->latest_key_event = key_event; // å­˜æ”¾å¾—åˆ°çš„æŒ‰é”®äº‹ä»¶
 250   3      
 251   3                  // printf("notify\n");
 252   3              }
 253   2              // else if (KEY_TYPE_TOUCH == scan_para->key_type) // å¦‚æžœæ˜¯è§¦æ‘¸æŒ‰é”®
 254   2              // {
 255   2              //     scan_para->click_cnt = 0;         // æŒ‰ä¸‹æ¬¡æ•°æ¸…0
 256   2              //     scan_para->notify_value = NO_KEY; // åœ¨å»¶æ—¶çš„å¾…å‘é€æŒ‰é”®å€¼æ¸…é›¶
 257   2      
 258   2              //     scan_para->latest_key_val = key_value;   // å­˜æ”¾å¾—åˆ°çš„æŒ‰é”®é”®å€¼
 259   2              //     scan_para->latest_key_event = key_event; // å­˜æ”¾å¾—åˆ°çš„æŒ‰é”®äº‹ä»¶
 260   2              // }
 261   2          }
 262   1      
 263   1      _scan_end:
 264   1          scan_para->last_key = cur_key_value;
 265   1          return;
 266   1      #endif
 267   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    436    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =      4       2
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
